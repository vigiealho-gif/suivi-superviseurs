<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi Superviseurs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß CONFIGURATION FIREBASE ‚Äî √Ä REMPLACER PAR LES V√îTRES
  // Instructions dans le bandeau rouge en bas de page
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const firebaseConfig = {
    apiKey: "AIzaSyAInuOMBu-cXrb3-owI92VZ_f8TDJwVNNU",
    authDomain: "suivi-superviseurs.firebaseapp.com",
    databaseURL: "https://suivi-superviseurs-default-rtdb.firebaseio.com",
    projectId: "suivi-superviseurs",
    storageBucket: "suivi-superviseurs.firebasestorage.app",
    messagingSenderId: "858642119661",
    appId: "1:858642119661:web:c076d8e2c3f93cb6bb85e4",
    measurementId: "G-5TM45H3R09"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const dbRef = ref(db, 'suivi/data');

  // Expose to global scope
  window._fbSave = async (data) => {
    await set(dbRef, data);
  };
  window._fbListen = (callback) => {
    onValue(dbRef, (snapshot) => {
      callback(snapshot.val());
    });
  };
  window._fbGet = async () => {
    const snap = await get(dbRef);
    return snap.val();
  };
  window._firebaseReady = true;
  document.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
:root {
  --primary:#1a3a6b; --accent:#4285f4; --green:#2ead6b;
  --bg:#f4f6fb; --card:#fff; --border:#dde3f0;
  --text:#1a2340; --soft:#6b7a99;
  --macro:#eaf2ff; --macro-h:#d0e4ff;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}

/* ‚îÄ‚îÄ SETUP BANNER ‚îÄ‚îÄ */
#setupBanner {
  background: #b71c1c; color: white;
  padding: 14px 24px; font-size: 13px; line-height: 1.7;
  border-bottom: 3px solid #7f0000;
}
#setupBanner strong { font-size: 14px; display: block; margin-bottom: 4px; }
#setupBanner code {
  background: rgba(255,255,255,0.2); padding: 2px 6px;
  border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 12px;
}
#setupBanner a { color: #ffcdd2; }
.banner-close {
  float: right; background: none; border: none; color: white;
  font-size: 20px; cursor: pointer; margin-top: -2px;
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-screen {
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; background:linear-gradient(135deg,#1a3a6b 0%,#2e5fab 100%);
}
.login-card {
  background:white; border-radius:18px; padding:40px 44px;
  width:380px; box-shadow:0 24px 64px rgba(0,0,0,0.25); text-align:center;
}
.login-card .logo { font-size: 40px; margin-bottom: 12px; }
.login-card h1 { font-size:22px; font-weight:700; color:var(--primary); margin-bottom:6px; }
.login-card p { color:var(--soft); font-size:13px; margin-bottom:28px; }
.login-card input {
  width:100%; padding:12px 14px; border:2px solid var(--border);
  border-radius:10px; font-family:'DM Sans',sans-serif; font-size:14px;
  margin-bottom:14px; transition:border-color 0.2s; outline:none;
}
.login-card input:focus { border-color:var(--accent); }
.login-btn {
  width:100%; padding:12px; background:var(--primary); color:white;
  border:none; border-radius:10px; font-family:'DM Sans',sans-serif;
  font-size:15px; font-weight:600; cursor:pointer; transition:background 0.2s;
}
.login-btn:hover { background:#0f2450; }
.login-error { color:#e53935; font-size:12px; margin-top:8px; display:none; }

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
.app { display:none; }

header {
  background:var(--primary); padding:12px 22px;
  display:flex; align-items:center; justify-content:space-between;
  box-shadow:0 2px 16px rgba(0,0,0,0.18); position:sticky; top:0; z-index:100;
}
.header-left h1 { color:white; font-size:16px; font-weight:600; }
.header-left span { color:#9ab4e0; font-size:11px; }
.header-right { display:flex; align-items:center; gap:10px; }
.user-badge {
  background:rgba(255,255,255,0.15); color:white;
  padding:5px 12px; border-radius:20px; font-size:12px; font-weight:500;
}
.sync-pill {
  display:flex; align-items:center; gap:6px;
  background:rgba(255,255,255,0.1); padding:4px 10px;
  border-radius:20px; color:white; font-size:11px;
}
.dot {
  width:7px; height:7px; border-radius:50%; background:#4caf50;
  animation:pulse 2s infinite;
}
.dot.off { background:#f44336; animation:none; }
.dot.busy { background:#ff9800; animation:none; }
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.3;} }

.btn-export {
  background:var(--green); color:white; border:none; padding:8px 16px;
  border-radius:8px; font-family:'DM Sans',sans-serif; font-size:13px;
  font-weight:600; cursor:pointer; transition:background 0.2s; white-space:nowrap;
}
.btn-export:hover { background:#22995e; }

.legend {
  margin:12px 20px 0; background:#e8f0fe; border-left:4px solid var(--accent);
  padding:8px 14px; border-radius:0 8px 8px 0; font-size:12px; color:var(--primary);
}
.badge { background:#d0e4ff; padding:1px 7px; border-radius:4px; font-weight:600; font-size:11px; }

.table-wrapper {
  margin:12px 20px 20px; background:var(--card);
  border-radius:10px; box-shadow:0 2px 12px rgba(26,58,107,0.08);
  overflow:auto; border:1px solid var(--border);
}
table { width:100%; border-collapse:collapse; font-size:12px; }
thead th {
  background:var(--primary); color:white; padding:10px 10px;
  text-align:left; font-weight:600; font-size:11px;
  border-right:1px solid rgba(255,255,255,0.1);
  position:sticky; top:0; white-space:nowrap;
}
thead th.mc { background:#0f2450; }
thead th:last-child { border-right:none; }
tbody tr { border-bottom:1px solid var(--border); transition:background 0.1s; }
tbody tr:last-child { border-bottom:none; }
tbody tr:hover { background:#f7f9ff; }
td {
  padding:7px 10px; vertical-align:top;
  border-right:1px solid var(--border); line-height:1.5;
}
td:last-child { border-right:none; }
.tn { font-family:'DM Mono',monospace; font-size:11px; color:var(--soft); }
.tname { font-weight:600; color:var(--primary); }
.tdate { font-size:11px; color:var(--soft); white-space:nowrap; }
.ttxt { min-width:140px; max-width:200px; font-size:12px; }

td.mcell {
  background:var(--macro); cursor:pointer;
  min-width:150px; max-width:220px;
  transition:background 0.15s; position:relative;
}
td.mcell:hover { background:var(--macro-h); }
td.mcell::after {
  content:'‚úé'; position:absolute; top:4px; right:6px;
  font-size:10px; color:var(--accent); opacity:0.45;
}
td.mcell:hover::after { opacity:1; }

.tag-list { display:flex; flex-direction:column; gap:3px; }
.tag { border-radius:4px; padding:2px 7px; font-size:10.5px; font-weight:500; display:inline-block; line-height:1.4; }
.tag.b { background:#1a3a6b; color:white; }
.tag.s { background:#1e6b3a; color:white; }
.tag.a { background:#5c3d8f; color:white; }
.ehint { color:#b0bcd4; font-size:11px; font-style:italic; }
.eby { font-size:10px; color:#9ab4e0; margin-top:3px; font-style:italic; }

/* ‚îÄ‚îÄ ONLINE USERS ‚îÄ‚îÄ */
.online-bar {
  margin:0 20px 10px; display:flex; align-items:center; gap:8px;
  font-size:12px; color:var(--soft);
}
.online-user {
  background:#e8f5e9; color:#1e6b3a; border-radius:20px;
  padding:3px 10px; font-size:11px; font-weight:600;
  border:1px solid #c8e6c9;
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay {
  display:none; position:fixed; inset:0;
  background:rgba(10,20,50,0.55); backdrop-filter:blur(3px);
  z-index:999; align-items:center; justify-content:center;
}
.overlay.open { display:flex; }
.modal {
  background:white; border-radius:14px; width:520px;
  max-width:95vw; max-height:85vh; display:flex; flex-direction:column;
  box-shadow:0 24px 64px rgba(0,0,0,0.25); animation:mi 0.18s ease;
}
@keyframes mi { from{opacity:0;transform:scale(0.95) translateY(10px);} to{opacity:1;transform:scale(1) translateY(0);} }
.mh {
  padding:16px 22px 13px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
}
.mh h2 { font-size:15px; font-weight:700; color:var(--primary); }
.mh .xbtn { background:none; border:none; font-size:20px; cursor:pointer; color:var(--soft); }
.mh .xbtn:hover { color:var(--text); }
.mb { overflow-y:auto; padding:12px 18px; flex:1; }
.ci {
  display:flex; align-items:flex-start; gap:11px;
  padding:9px 10px; border-radius:8px; margin-bottom:3px;
  border:2px solid transparent; transition:background 0.12s, border-color 0.12s;
}
.ci:hover { background:#f0f5ff; }
.ci.ck { background:#e8f0fe; border-color:#4285f4; }
.ci input[type=checkbox] {
  width:17px; height:17px; accent-color:var(--accent);
  flex-shrink:0; margin-top:2px; cursor:pointer;
}
.ci label { font-size:13px; line-height:1.5; cursor:pointer; color:var(--text); flex:1; }
.ci.ck label { color:var(--primary); font-weight:500; }
.mf {
  padding:12px 22px; border-top:1px solid var(--border);
  display:flex; gap:10px; justify-content:flex-end; flex-shrink:0;
}
.sc2 { font-size:12px; color:var(--soft); align-self:center; margin-right:auto; }
.sc2 strong { color:var(--accent); }
.bcn {
  background:none; border:1.5px solid var(--border); color:var(--soft);
  padding:8px 18px; border-radius:8px; font-family:'DM Sans',sans-serif;
  font-size:13px; font-weight:500; cursor:pointer;
}
.bcn:hover { border-color:#aaa; color:var(--text); }
.bok {
  background:var(--accent); color:white; border:none; padding:8px 22px;
  border-radius:8px; font-family:'DM Sans',sans-serif; font-size:13px;
  font-weight:600; cursor:pointer;
}
.bok:hover { background:#3367d6; }

.add-btn {
  margin:0 20px 20px; background:none; border:2px dashed var(--border);
  border-radius:8px; padding:10px; width:calc(100% - 40px);
  color:var(--soft); font-family:'DM Sans',sans-serif; font-size:13px;
  cursor:pointer; transition:all 0.15s;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.add-btn:hover { border-color:var(--accent); color:var(--accent); background:#f0f5ff; }

.toast {
  position:fixed; bottom:24px; right:24px;
  background:#1e3a5f; color:white; padding:10px 18px;
  border-radius:8px; font-size:13px; font-weight:500;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
  transform:translateY(80px); opacity:0;
  transition:all 0.3s; z-index:9999;
}
.toast.show { transform:translateY(0); opacity:1; }

/* ‚îÄ‚îÄ CONFIG NOT SET ‚îÄ‚îÄ */
#notConfigured {
  display:none; background:#fff3e0; border:2px solid #ff9800;
  border-radius:12px; padding:24px; margin:24px; text-align:center;
}
#notConfigured h2 { color:#e65100; margin-bottom:10px; }
#notConfigured p { color:#bf360c; font-size:13px; line-height:1.7; }
#notConfigured code {
  background:#ffe0b2; padding:2px 7px; border-radius:4px;
  font-family:'DM Mono',monospace; font-size:12px;
}
</style>
</head>
<body>

<!-- SETUP INSTRUCTIONS BANNER -->
<div id="setupBanner">
  <button class="banner-close" onclick="document.getElementById('setupBanner').style.display='none'">‚úï</button>
  <strong>‚öôÔ∏è CONFIGURATION REQUISE ‚Äî √Ä faire une seule fois (5 min)</strong>
  1. Va sur <a href="https://console.firebase.google.com" target="_blank"><strong>console.firebase.google.com</strong></a> ‚Üí Cr√©er un projet (gratuit) ‚Üí Active <strong>Realtime Database</strong> ‚Üí Mode test<br>
  2. Dans Param√®tres du projet ‚Üí Tes applications ‚Üí Ajoute une app Web ‚Üí Copie la config<br>
  3. Dans ce fichier HTML, remplace <code>VOTRE_API_KEY</code>, <code>VOTRE_PROJECT</code> etc. par ta vraie config Firebase<br>
  4. D√©pose le fichier sur <strong>Netlify Drop</strong> ‚Üí Partage le lien √† tous les superviseurs ‚úÖ
</div>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="logo">üìã</div>
    <h1>Suivi Superviseurs</h1>
    <p>Tableau collaboratif ‚Äî toutes les modifications sont visibles par tous en temps r√©el</p>
    <input type="text" id="nameInput" placeholder="Votre pr√©nom (ex : SAFAE)"
           maxlength="30" onkeydown="if(event.key==='Enter') login()">
    <button class="login-btn" onclick="login()">Acc√©der au tableau ‚Üí</button>
    <p class="login-error" id="loginError">Veuillez entrer votre pr√©nom</p>
  </div>
</div>

<!-- APP -->
<div class="app" id="appScreen">
  <header>
    <div class="header-left">
      <h1>üìã Suivi Superviseurs ‚Äî Collaboratif</h1>
      <span>Les modifications sont visibles par tous les superviseurs instantan√©ment</span>
    </div>
    <div class="header-right">
      <div class="sync-pill">
        <div class="dot" id="syncDot"></div>
        <span id="syncLabel">Connexion...</span>
      </div>
      <span class="user-badge">üë§ <span id="userDisplay"></span></span>
      <button class="btn-export" onclick="exportExcel()">‚¨áÔ∏è Exporter Excel</button>
    </div>
  </header>

  <div class="online-bar" id="onlineBar">
    <span>üü¢ En ligne :</span>
  </div>

  <div class="legend">
    üí° Colonnes originales conserv√©es +
    <span class="badge">üîµ Blocage</span>
    <span class="badge">üü¢ Solution</span>
    <span class="badge">üü£ Arguments</span>
    avec choix multiples ‚Äî cliquez pour cocher plusieurs options
  </div>

  <div id="notConfigured">
    <h2>‚ö†Ô∏è Firebase non configur√©</h2>
    <p>
      Remplace les valeurs <code>VOTRE_API_KEY</code>, <code>VOTRE_PROJECT</code> etc.<br>
      dans le code HTML par ta vraie configuration Firebase.<br>
      Consulte le bandeau rouge en haut de la page pour les instructions.
    </p>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Date</th>
          <th>Log Agent</th>
          <th>Num Dossier</th>
          <th>Col.5</th>
          <th>Blocage rencontr√©</th>
          <th>Solution propos√©e</th>
          <th>Arguments</th>
          <th>R√©it√©ration</th>
          <th class="mc">üîµ Blocage ‚Äî Choix</th>
          <th class="mc">üü¢ Solution ‚Äî Choix</th>
          <th class="mc">üü£ Arguments ‚Äî Choix</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  <button class="add-btn" onclick="addRow()">Ôºã Ajouter une ligne</button>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay" onclick="if(event.target.id==='overlay')closeModal()">
  <div class="modal">
    <div class="mh">
      <h2 id="modalTitle"></h2>
      <button class="xbtn" onclick="closeModal()">‚úï</button>
    </div>
    <div class="mb" id="modalBody"></div>
    <div class="mf">
      <span class="sc2"><strong id="cnt">0</strong> s√©lectionn√©(s)</span>
      <button class="bcn" onclick="closeModal()">Annuler</button>
      <button class="bok" onclick="saveModal()">‚úì Valider</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CHOICES ‚îÄ‚îÄ
const BLOCAGES = [
  "Il se sent bloqu√© par le process",
  "Il n'est pas satisfait de la r√©ponse apport√©e par le conseiller",
  "Il estime que sa demande n'est pas comprise",
  "Il souhaite une d√©cision plus rapide ou d√©finitive",
  "Il pense qu'un responsable a plus de pouvoir de d√©cision",
  "Il est en situation de multi-r√©it√©ration",
  "Il est tr√®s √©motionnel / en col√®re",
  "Il veut faire pression pour obtenir un geste commercial",
  "Il menace de laisser un avis n√©gatif ou de faire un signalement",
  "Il cherche simplement √† √™tre rassur√© ou reconnu",
  "Par principe, il demande toujours un responsable"
];
const SOLUTIONS = [
  "Faire un arbitrage exceptionnel hors process",
  "Maintenir la position avec une posture ferme",
  "Donner une explication claire et p√©dagogique du process",
  "Proposer une alternative conforme au process",
  "Apporter une d√©cision finale claire",
  "Accorder un geste commercial adapt√© et justifi√©"
];
const ARGUMENTS = [
  "Nombre de r√©it√©rations √©lev√©",
  "Dur√©e de traitement anormalement longue",
  "Erreur ou mauvaise information donn√©e pr√©c√©demment",
  "Analyse du narratif client coh√©rente et cr√©dible",
  "Risque r√©putationnel (avis n√©gatif, r√©seaux sociaux, signalement)",
  "Chiffre d'affaires g√©n√©r√© par le client",
  "Historique client positif",
  "Blocage per√ßu comme injuste ou incoh√©rent",
  "Impact √©motionnel important (client en forte d√©tresse ou col√®re)"
];

const DEFAULT = [
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"121014391",c5:"",bt:"Refus de prise en charge d'une panne en p√©riode de garantie produit CD gestion marque",st:"Creation d'une NA livraison multiple contre rembourssement",at:"La cliente r√©it√®re √† plusieurs reprises concernant un produit achet√© il y a un mois.\nLa marque invoque une exclusion de garantie sans explication d√©taill√©e.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"120950398",c5:"",bt:"Commande non re√ßu MP, le vendeur indique que le colis est livr√©, le client confirme qu'il n'a rien re√ßu",st:"Aattente PJ contestation de livraison puis rembourssement",at:"Apr√®s r√©cup√©ration des √©changes et des preuves fournies par le vendeur.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"120760365",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-16",a:"",dos:"120967488",c5:"",bt:"",st:"",at:"",rei:"1",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-18",a:"",dos:"121018945",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Fatima",d:"2026-02-19",a:"N2ALH_olamiri",dos:"121031690",c5:"",bt:"Produit en panne depuis le mois Janvier le client demande une intervention de CDS car la marque ne r√©pond pas favorablement √† sa demande",st:"Cr√©ation d'une NA multiple pour un remboursement",at:"Puisque le client a r√©it√©r√© sa demande √† plusieurs reprises sans obtenir de solution, j'ai propos√© un bon de retour.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-18",a:"",dos:"121015949",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"121040452",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Fatima",d:"2026-02-19",a:"N2ALh_kbouzid",dos:"121036024",c5:"",bt:"Le client signale un accesoire manquant",st:"Cr√©ation d'une NA multiple",at:"C'est l'agent qui a g√©r√© l'appel, puisqu'il avait communiqu√© une promesse de rappel au client.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-19",a:"N2ALh_kbouzid",dos:"121026199",c5:"",bt:"La cliente n'a pas re√ßu le colis et son dossier a √©t√© transf√©r√© au service de recouvrement.",st:"Explication de la proc√©dure √† suivre pour nous envoyer l'ATH.",at:"La cliente n'arrive pas √† nous transf√©rer les pi√®ces jointes.",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-20",a:"",dos:"121049579",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-20",a:"",dos:"121047287",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-20",a:"N2ALH_aelbadmoussi",dos:"121050398",c5:"",bt:"La cliente signal un retard de livraison",st:"Remboursement de la commande",at:"Puisque la cliente a refus√© de patienter, j'ai proc√©d√© √† son remboursement imm√©diat.",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"Ikram",d:"2026-02-20",a:"N2ALH_skarman",dos:"120283014",c5:"",bt:"Produit en panne: mises √† jour impossibles et absence de solution conforme du vendeur",st:"Remboursement",at:"La cliente a retourn√© le t√©l√©phone au vendeur, qui l'a r√©ceptionn√© le 31/01/2026.",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-20",a:"N2ALH_Selbaz",dos:"121009349",c5:"",bt:"Produit en panne",st:"",at:"",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-20",a:"N2ALH_camezian",dos:"121057966",c5:"",bt:"Remboursement non re√ßu",st:"RAS",at:"Le client confirme la rec√©ption de son RBT finallement",rei:"",bc:[],sc:[],ac:[],by:""}
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser = '';
let tableData = [];
let cRI = -1, cF = '', cCh = [];
let fbReady = false;
let isRemoteUpdate = false;

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
function login() {
  const n = document.getElementById('nameInput').value.trim();
  if (!n) { document.getElementById('loginError').style.display='block'; return; }
  currentUser = n.toUpperCase();
  document.getElementById('userDisplay').textContent = currentUser;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';
  initFirebase();
}

// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ
function initFirebase() {
  setStatus('busy', 'Connexion...');

  // Check if Firebase was properly configured
  const isConfigured = true;

  if (!isConfigured) {
    document.getElementById('notConfigured').style.display = 'block';
    setStatus('off', 'Non configur√©');
    // Still work locally with default data
    tableData = JSON.parse(JSON.stringify(DEFAULT));
    renderTable();
    return;
  }

  document.addEventListener('firebase-ready', () => {
    fbReady = true;

    // Listen for realtime changes
    window._fbListen((data) => {
      if (data) {
        const incoming = Object.values(data);
        // Only update if data is different from what we sent
        if (JSON.stringify(incoming) !== JSON.stringify(tableData) || tableData.length === 0) {
          isRemoteUpdate = true;
          tableData = incoming;
          renderTable();
          if (tableData.length > 0) {
            showToast('üîÑ Tableau mis √† jour');
          }
          isRemoteUpdate = false;
        }
      } else {
        // No data yet ‚Äî push default
        tableData = JSON.parse(JSON.stringify(DEFAULT));
        save();
        renderTable();
      }
      setStatus('on', 'En direct ‚ö°');
    });

    // Track online presence
    trackPresence();
  });
}

async function save() {
  if (!fbReady) return;
  setStatus('busy', 'Sauvegarde...');
  try {
    const obj = {};
    tableData.forEach((row, i) => obj[i] = row);
    await window._fbSave(obj);
    setStatus('on', 'En direct ‚ö°');
  } catch(e) {
    setStatus('off', 'Erreur sync');
    showToast('‚ö†Ô∏è Erreur de synchronisation');
  }
}

function trackPresence() {
  // Simple presence: save username with timestamp every 30s
  const presenceKey = 'suivi/online/' + currentUser.replace(/\s/g,'_');
  const updatePresence = async () => {
    try {
      const { getDatabase, ref, set, onDisconnect } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js");
      // We use a simpler approach via the global db
    } catch(e) {}
  };
}

function setStatus(state, label) {
  const dot = document.getElementById('syncDot');
  const lbl = document.getElementById('syncLabel');
  dot.className = 'dot' + (state === 'off' ? ' off' : state === 'busy' ? ' busy' : '');
  lbl.textContent = label;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderTable() {
  const tbody = document.getElementById('tableBody');
  // Save scroll position
  const wrapper = document.querySelector('.table-wrapper');
  const scrollTop = wrapper.scrollTop;

  tbody.innerHTML = '';
  tableData.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="tname" contenteditable="true" onblur="upd(${i},'r',this.innerText)">${esc(row.r)}</td>
      <td class="tdate" contenteditable="true" onblur="upd(${i},'d',this.innerText)">${esc(row.d)}</td>
      <td contenteditable="true" onblur="upd(${i},'a',this.innerText)">${esc(row.a)}</td>
      <td class="tn" contenteditable="true" onblur="upd(${i},'dos',this.innerText)">${esc(row.dos)}</td>
      <td contenteditable="true" onblur="upd(${i},'c5',this.innerText)">${esc(row.c5)}</td>
      <td class="ttxt" contenteditable="true" onblur="upd(${i},'bt',this.innerText)">${esc(row.bt)}</td>
      <td class="ttxt" contenteditable="true" onblur="upd(${i},'st',this.innerText)">${esc(row.st)}</td>
      <td class="ttxt" contenteditable="true" onblur="upd(${i},'at',this.innerText)">${esc(row.at)}</td>
      <td class="tn" contenteditable="true" onblur="upd(${i},'rei',this.innerText)">${esc(row.rei)}</td>
      <td class="mcell" onclick="openModal(${i},'bc')">
        ${renderTags(row.bc,'b')}
        ${row.by ? `<div class="eby">‚úèÔ∏è ${esc(row.by)}</div>` : ''}
      </td>
      <td class="mcell" onclick="openModal(${i},'sc')">${renderTags(row.sc,'s')}</td>
      <td class="mcell" onclick="openModal(${i},'ac')">${renderTags(row.ac,'a')}</td>
    `;
    tbody.appendChild(tr);
  });

  wrapper.scrollTop = scrollTop;
}

function renderTags(arr, cls) {
  if (!arr || !arr.length) return '<span class="ehint">Cliquer pour choisir...</span>';
  return '<div class="tag-list">'+arr.map(v=>`<span class="tag ${cls}">${esc(v)}</span>`).join('')+'</div>';
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function upd(i, f, v) {
  tableData[i][f] = v.trim();
  tableData[i].by = currentUser;
  await save();
  showToast('‚úÖ Sauvegard√©');
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(ri, field) {
  cRI = ri; cF = field;
  const titles = { bc:'üîµ Blocage rencontr√©', sc:'üü¢ Solution propos√©e', ac:'üü£ Arguments' };
  const maps   = { bc:BLOCAGES, sc:SOLUTIONS, ac:ARGUMENTS };
  cCh = maps[field];
  const sel = tableData[ri][field] || [];

  document.getElementById('modalTitle').textContent = titles[field];
  document.getElementById('modalBody').innerHTML = cCh.map((c, i) => {
    const chk = sel.includes(c);
    return `<div class="ci ${chk?'ck':''}" id="ci_${i}">
      <input type="checkbox" id="chk_${i}" ${chk?'checked':''} onchange="sc2(${i})">
      <label for="chk_${i}">${esc(c)}</label>
    </div>`;
  }).join('');

  updCnt();
  document.getElementById('overlay').classList.add('open');
}

function sc2(i) {
  const chk = document.getElementById('chk_'+i);
  document.getElementById('ci_'+i).classList.toggle('ck', chk.checked);
  updCnt();
}
function updCnt() {
  document.getElementById('cnt').textContent =
    document.querySelectorAll('#modalBody input:checked').length;
}
async function saveModal() {
  const sel = [];
  cCh.forEach((c, i) => { if(document.getElementById('chk_'+i)?.checked) sel.push(c); });
  tableData[cRI][cF] = sel;
  tableData[cRI].by = currentUser;
  closeModal();
  renderTable();
  await save();
  showToast('‚úÖ Modifications partag√©es avec tous les superviseurs');
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); }

// ‚îÄ‚îÄ ADD ROW ‚îÄ‚îÄ
async function addRow() {
  tableData.push({
    r:currentUser, d:new Date().toISOString().slice(0,10),
    a:'', dos:'', c5:'', bt:'', st:'', at:'', rei:'',
    bc:[], sc:[], ac:[], by:currentUser
  });
  renderTable();
  await save();
  document.querySelector('.table-wrapper').scrollTop = 999999;
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportExcel() {
  const rows = [["Responsable","Date","Log Agent","Num Dossier","Col.5",
    "Blocage rencontr√©","Solution propos√©e","Arguments","R√©it√©ration",
    "Blocage ‚Äî Choix","Solution ‚Äî Choix","Arguments ‚Äî Choix","Modifi√© par"]];
  tableData.forEach(r => rows.push([
    r.r,r.d,r.a,r.dos,r.c5,r.bt,r.st,r.at,r.rei,
    (r.bc||[]).join('\n'),(r.sc||[]).join('\n'),(r.ac||[]).join('\n'),r.by||''
  ]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:14},{wch:12},{wch:16},{wch:13},{wch:6},
    {wch:34},{wch:34},{wch:34},{wch:10},{wch:34},{wch:34},{wch:34},{wch:12}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Feuil1");
  XLSX.writeFile(wb, "suivi_superviseurs.xlsx");
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>
