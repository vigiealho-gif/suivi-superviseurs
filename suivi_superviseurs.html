<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi Superviseurs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->


<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
:root {
  --primary:#1a3a6b; --accent:#4285f4; --green:#2ead6b;
  --bg:#f4f6fb; --card:#fff; --border:#dde3f0;
  --text:#1a2340; --soft:#6b7a99;
  --macro:#eaf2ff; --macro-h:#d0e4ff;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}

/* ‚îÄ‚îÄ SETUP BANNER ‚îÄ‚îÄ */
#setupBanner {
  background: #b71c1c; color: white;
  padding: 14px 24px; font-size: 13px; line-height: 1.7;
  border-bottom: 3px solid #7f0000;
}
#setupBanner strong { font-size: 14px; display: block; margin-bottom: 4px; }
#setupBanner code {
  background: rgba(255,255,255,0.2); padding: 2px 6px;
  border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 12px;
}
#setupBanner a { color: #ffcdd2; }
.banner-close {
  float: right; background: none; border: none; color: white;
  font-size: 20px; cursor: pointer; margin-top: -2px;
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-screen {
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; background:linear-gradient(135deg,#1a3a6b 0%,#2e5fab 100%);
}
.login-card {
  background:white; border-radius:18px; padding:40px 44px;
  width:380px; box-shadow:0 24px 64px rgba(0,0,0,0.25); text-align:center;
}
.login-card .logo { font-size: 40px; margin-bottom: 12px; }
.login-card h1 { font-size:22px; font-weight:700; color:var(--primary); margin-bottom:6px; }
.login-card p { color:var(--soft); font-size:13px; margin-bottom:28px; }
.login-card input {
  width:100%; padding:12px 14px; border:2px solid var(--border);
  border-radius:10px; font-family:'DM Sans',sans-serif; font-size:14px;
  margin-bottom:14px; transition:border-color 0.2s; outline:none;
}
.login-card input:focus { border-color:var(--accent); }
.login-btn {
  width:100%; padding:12px; background:var(--primary); color:white;
  border:none; border-radius:10px; font-family:'DM Sans',sans-serif;
  font-size:15px; font-weight:600; cursor:pointer; transition:background 0.2s;
}
.login-btn:hover { background:#0f2450; }
.login-error { color:#e53935; font-size:12px; margin-top:8px; display:none; }

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
.app { display:none; }

header {
  background:var(--primary); padding:12px 22px;
  display:flex; align-items:center; justify-content:space-between;
  box-shadow:0 2px 16px rgba(0,0,0,0.18); position:sticky; top:0; z-index:100;
}
.header-left h1 { color:white; font-size:16px; font-weight:600; }
.header-left span { color:#9ab4e0; font-size:11px; }
.header-right { display:flex; align-items:center; gap:10px; }
.user-badge {
  background:rgba(255,255,255,0.15); color:white;
  padding:5px 12px; border-radius:20px; font-size:12px; font-weight:500;
}
.sync-pill {
  display:flex; align-items:center; gap:6px;
  background:rgba(255,255,255,0.1); padding:4px 10px;
  border-radius:20px; color:white; font-size:11px;
}
.dot {
  width:7px; height:7px; border-radius:50%; background:#4caf50;
  animation:pulse 2s infinite;
}
.dot.off { background:#f44336; animation:none; }
.dot.busy { background:#ff9800; animation:none; }
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.3;} }

.btn-export {
  background:var(--green); color:white; border:none; padding:8px 16px;
  border-radius:8px; font-family:'DM Sans',sans-serif; font-size:13px;
  font-weight:600; cursor:pointer; transition:background 0.2s; white-space:nowrap;
}
.btn-export:hover { background:#22995e; }

.legend {
  margin:12px 20px 0; background:#e8f0fe; border-left:4px solid var(--accent);
  padding:8px 14px; border-radius:0 8px 8px 0; font-size:12px; color:var(--primary);
}
.badge { background:#d0e4ff; padding:1px 7px; border-radius:4px; font-weight:600; font-size:11px; }

.table-wrapper {
  margin:12px 20px 20px; background:var(--card);
  border-radius:10px; box-shadow:0 2px 12px rgba(26,58,107,0.08);
  overflow:auto; border:1px solid var(--border);
}
table { width:100%; border-collapse:collapse; font-size:12px; }
thead th {
  background:var(--primary); color:white; padding:10px 10px;
  text-align:left; font-weight:600; font-size:11px;
  border-right:1px solid rgba(255,255,255,0.1);
  position:sticky; top:0; white-space:nowrap;
}
thead th.mc { background:#0f2450; }
thead th:last-child { border-right:none; }
tbody tr { border-bottom:1px solid var(--border); transition:background 0.1s; }
tbody tr:last-child { border-bottom:none; }
tbody tr:hover { background:#f7f9ff; }
td {
  padding:7px 10px; vertical-align:top;
  border-right:1px solid var(--border); line-height:1.5;
}
td:last-child { border-right:none; }
.tn { font-family:'DM Mono',monospace; font-size:11px; color:var(--soft); }
.tname { font-weight:600; color:var(--primary); }
.tdate { font-size:11px; color:var(--soft); white-space:nowrap; }
.ttxt { min-width:140px; max-width:200px; font-size:12px; }

td.mcell {
  background:var(--macro); cursor:pointer;
  min-width:150px; max-width:220px;
  transition:background 0.15s; position:relative;
}
td.mcell:hover { background:var(--macro-h); }
td.mcell::after {
  content:'‚úé'; position:absolute; top:4px; right:6px;
  font-size:10px; color:var(--accent); opacity:0.45;
}
td.mcell:hover::after { opacity:1; }

.tag-list { display:flex; flex-direction:column; gap:3px; }
.tag { border-radius:4px; padding:2px 7px; font-size:10.5px; font-weight:500; display:inline-block; line-height:1.4; }
.tag.b { background:#1a3a6b; color:white; }
.tag.s { background:#1e6b3a; color:white; }
.tag.a { background:#5c3d8f; color:white; }
.ehint { color:#b0bcd4; font-size:11px; font-style:italic; }
.eby { font-size:10px; color:#9ab4e0; margin-top:3px; font-style:italic; }

/* ‚îÄ‚îÄ ONLINE USERS ‚îÄ‚îÄ */
.online-bar {
  margin:0 20px 10px; display:flex; align-items:center; gap:8px;
  font-size:12px; color:var(--soft);
}
.online-user {
  background:#e8f5e9; color:#1e6b3a; border-radius:20px;
  padding:3px 10px; font-size:11px; font-weight:600;
  border:1px solid #c8e6c9;
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay {
  display:none; position:fixed; inset:0;
  background:rgba(10,20,50,0.55); backdrop-filter:blur(3px);
  z-index:999; align-items:center; justify-content:center;
}
.overlay.open { display:flex; }
.modal {
  background:white; border-radius:14px; width:520px;
  max-width:95vw; max-height:85vh; display:flex; flex-direction:column;
  box-shadow:0 24px 64px rgba(0,0,0,0.25); animation:mi 0.18s ease;
}
@keyframes mi { from{opacity:0;transform:scale(0.95) translateY(10px);} to{opacity:1;transform:scale(1) translateY(0);} }
.mh {
  padding:16px 22px 13px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
}
.mh h2 { font-size:15px; font-weight:700; color:var(--primary); }
.mh .xbtn { background:none; border:none; font-size:20px; cursor:pointer; color:var(--soft); }
.mh .xbtn:hover { color:var(--text); }
.mb { overflow-y:auto; padding:12px 18px; flex:1; }
.ci {
  display:flex; align-items:flex-start; gap:11px;
  padding:9px 10px; border-radius:8px; margin-bottom:3px;
  border:2px solid transparent; transition:background 0.12s, border-color 0.12s;
}
.ci:hover { background:#f0f5ff; }
.ci.ck { background:#e8f0fe; border-color:#4285f4; }
.ci input[type=checkbox] {
  width:17px; height:17px; accent-color:var(--accent);
  flex-shrink:0; margin-top:2px; cursor:pointer;
}
.ci label { font-size:13px; line-height:1.5; cursor:pointer; color:var(--text); flex:1; }
.ci.ck label { color:var(--primary); font-weight:500; }
.mf {
  padding:12px 22px; border-top:1px solid var(--border);
  display:flex; gap:10px; justify-content:flex-end; flex-shrink:0;
}
.sc2 { font-size:12px; color:var(--soft); align-self:center; margin-right:auto; }
.sc2 strong { color:var(--accent); }
.bcn {
  background:none; border:1.5px solid var(--border); color:var(--soft);
  padding:8px 18px; border-radius:8px; font-family:'DM Sans',sans-serif;
  font-size:13px; font-weight:500; cursor:pointer;
}
.bcn:hover { border-color:#aaa; color:var(--text); }
.bok {
  background:var(--accent); color:white; border:none; padding:8px 22px;
  border-radius:8px; font-family:'DM Sans',sans-serif; font-size:13px;
  font-weight:600; cursor:pointer;
}
.bok:hover { background:#3367d6; }

.add-btn {
  margin:0 20px 20px; background:none; border:2px dashed var(--border);
  border-radius:8px; padding:10px; width:calc(100% - 40px);
  color:var(--soft); font-family:'DM Sans',sans-serif; font-size:13px;
  cursor:pointer; transition:all 0.15s;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.add-btn:hover { border-color:var(--accent); color:var(--accent); background:#f0f5ff; }

.toast {
  position:fixed; bottom:24px; right:24px;
  background:#1e3a5f; color:white; padding:10px 18px;
  border-radius:8px; font-size:13px; font-weight:500;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
  transform:translateY(80px); opacity:0;
  transition:all 0.3s; z-index:9999;
}
.toast.show { transform:translateY(0); opacity:1; }

/* ‚îÄ‚îÄ CONFIG NOT SET ‚îÄ‚îÄ */
#notConfigured {
  display:none; background:#fff3e0; border:2px solid #ff9800;
  border-radius:12px; padding:24px; margin:24px; text-align:center;
}
#notConfigured h2 { color:#e65100; margin-bottom:10px; }
#notConfigured p { color:#bf360c; font-size:13px; line-height:1.7; }
#notConfigured code {
  background:#ffe0b2; padding:2px 7px; border-radius:4px;
  font-family:'DM Mono',monospace; font-size:12px;
}
</style>
</head>
<body>

<!-- SETUP INSTRUCTIONS BANNER -->
<div id="setupBanner">
  <button class="banner-close" onclick="document.getElementById('setupBanner').style.display='none'">‚úï</button>
  <strong>‚öôÔ∏è CONFIGURATION REQUISE ‚Äî √Ä faire une seule fois (5 min)</strong>
  1. Va sur <a href="https://console.firebase.google.com" target="_blank"><strong>console.firebase.google.com</strong></a> ‚Üí Cr√©er un projet (gratuit) ‚Üí Active <strong>Realtime Database</strong> ‚Üí Mode test<br>
  2. Dans Param√®tres du projet ‚Üí Tes applications ‚Üí Ajoute une app Web ‚Üí Copie la config<br>
  3. Dans ce fichier HTML, remplace <code>VOTRE_API_KEY</code>, <code>VOTRE_PROJECT</code> etc. par ta vraie config Firebase<br>
  4. D√©pose le fichier sur <strong>Netlify Drop</strong> ‚Üí Partage le lien √† tous les superviseurs ‚úÖ
</div>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="logo">üìã</div>
    <h1>Suivi Superviseurs</h1>
    <p>Tableau collaboratif ‚Äî toutes les modifications sont visibles par tous en temps r√©el</p>
    <input type="text" id="nameInput" placeholder="Votre pr√©nom (ex : SAFAE)"
           maxlength="30" onkeydown="if(event.key==='Enter') login()">
    <button class="login-btn" onclick="login()">Acc√©der au tableau ‚Üí</button>
    <p class="login-error" id="loginError">Veuillez entrer votre pr√©nom</p>
  </div>
</div>

<!-- APP -->
<div class="app" id="appScreen">
  <header>
    <div class="header-left" style="display:flex;align-items:center;gap:16px;">
      <img src="data:image/png;base64,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" style="height:36px;object-fit:contain;background:white;padding:4px 8px;border-radius:6px;">
      <img src="data:image/png;base64,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" style="height:36px;object-fit:contain;background:white;padding:4px 8px;border-radius:6px;">
      <div>
        <h1>üìã Suivi Superviseurs ‚Äî Collaboratif</h1>
        <span>Les modifications sont visibles par tous les superviseurs instantan√©ment</span>
      </div>
    </div>
    <div class="header-right">
      <div class="sync-pill">
        <div class="dot" id="syncDot"></div>
        <span id="syncLabel">Connexion...</span>
      </div>
      <span class="user-badge">üë§ <span id="userDisplay"></span></span>
      <div style="text-align:right;">
        <div style="color:#9ab4e0;font-size:11px;">D√©velopp√©e par Sanae Soumar</div>
      </div>
      <button class="btn-export" onclick="exportExcel()">‚¨áÔ∏è Exporter Excel</button>
    </div>
  </header>

  <div class="online-bar" id="onlineBar">
    <span>üü¢ En ligne :</span>
  </div>

  <div class="legend">
    üí° Colonnes originales conserv√©es +
    <span class="badge">üîµ Blocage</span>
    <span class="badge">üü¢ Solution</span>
    <span class="badge">üü£ Arguments</span>
    avec choix multiples ‚Äî cliquez pour cocher plusieurs options
  </div>

  <div id="notConfigured">
    <h2>‚ö†Ô∏è Firebase non configur√©</h2>
    <p>
      Remplace les valeurs <code>VOTRE_API_KEY</code>, <code>VOTRE_PROJECT</code> etc.<br>
      dans le code HTML par ta vraie configuration Firebase.<br>
      Consulte le bandeau rouge en haut de la page pour les instructions.
    </p>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th style="width:40px;text-align:center;">üóëÔ∏è</th>
        <th>Responsable</th>
          <th>Date</th>
          <th>Log Agent</th>
          <th>Num Dossier</th>
          <th>R√©it√©ration</th>
          <th class="mc">üîµ Blocage ‚Äî Choix</th>
          <th class="mc">üü¢ Solution ‚Äî Choix</th>
          <th class="mc">üü£ Arguments ‚Äî Choix</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  <button class="add-btn" onclick="addRow()">Ôºã Ajouter une ligne</button>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay" onclick="if(event.target.id==='overlay')closeModal()">
  <div class="modal">
    <div class="mh">
      <h2 id="modalTitle"></h2>
      <button class="xbtn" onclick="closeModal()">‚úï</button>
    </div>
    <div class="mb" id="modalBody"></div>
    <div class="mf">
      <span class="sc2"><strong id="cnt">0</strong> s√©lectionn√©(s)</span>
      <button class="bcn" onclick="closeModal()">Annuler</button>
      <button class="bok" onclick="saveModal()">‚úì Valider</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CHOICES ‚îÄ‚îÄ
const BLOCAGES = [
  "Refus de la demande du client",
  "Blocage li√© √† l'application du process",
  "Solution apport√©e ne r√©pondant pas aux attentes du client",
  "D√©lai de traitement anormalement long",
  "La r√©ponse du vendeur ne convient pas au client",
  "R√©ponses contradictoires communiqu√©es au client"
];
const SOLUTIONS = [
  "Arbitrage exceptionnel hors process (remboursement)",
  "Proposer une alternative conforme au process",
  "Accorder un geste commercial adapt√© et justifi√©"
];
const ARGUMENTS = [
  "Nombre de r√©it√©rations √©lev√©",
  "Dur√©e de traitement anormalement longue",
  "Erreur ou mauvaise information donn√©e pr√©c√©demment",
  "Analyse du narratif client coh√©rente et cr√©dible",
  "Risque r√©putationnel (avis n√©gatif, r√©seaux sociaux, signalement)",
  "Chiffre d'affaires g√©n√©r√© par le client",
  "Historique client positif",
  "Blocage per√ßu comme injuste ou incoh√©rent",
  "Impact √©motionnel important (client en forte d√©tresse ou col√®re)"
];

const DEFAULT = [
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"121014391",c5:"",bt:"Refus de prise en charge d'une panne en p√©riode de garantie produit CD gestion marque",st:"Creation d'une NA livraison multiple contre rembourssement",at:"La cliente r√©it√®re √† plusieurs reprises concernant un produit achet√© il y a un mois.\nLa marque invoque une exclusion de garantie sans explication d√©taill√©e.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"120950398",c5:"",bt:"Commande non re√ßu MP, le vendeur indique que le colis est livr√©, le client confirme qu'il n'a rien re√ßu",st:"Aattente PJ contestation de livraison puis rembourssement",at:"Apr√®s r√©cup√©ration des √©changes et des preuves fournies par le vendeur.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"120760365",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-16",a:"",dos:"120967488",c5:"",bt:"",st:"",at:"",rei:"1",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-18",a:"",dos:"121018945",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Fatima",d:"2026-02-19",a:"N2ALH_olamiri",dos:"121031690",c5:"",bt:"Produit en panne depuis le mois Janvier le client demande une intervention de CDS car la marque ne r√©pond pas favorablement √† sa demande",st:"Cr√©ation d'une NA multiple pour un remboursement",at:"Puisque le client a r√©it√©r√© sa demande √† plusieurs reprises sans obtenir de solution, j'ai propos√© un bon de retour.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-18",a:"",dos:"121015949",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-19",a:"",dos:"121040452",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Fatima",d:"2026-02-19",a:"N2ALh_kbouzid",dos:"121036024",c5:"",bt:"Le client signale un accesoire manquant",st:"Cr√©ation d'une NA multiple",at:"C'est l'agent qui a g√©r√© l'appel, puisqu'il avait communiqu√© une promesse de rappel au client.",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-19",a:"N2ALh_kbouzid",dos:"121026199",c5:"",bt:"La cliente n'a pas re√ßu le colis et son dossier a √©t√© transf√©r√© au service de recouvrement.",st:"Explication de la proc√©dure √† suivre pour nous envoyer l'ATH.",at:"La cliente n'arrive pas √† nous transf√©rer les pi√®ces jointes.",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-20",a:"",dos:"121049579",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"SAFAE",d:"2026-02-20",a:"",dos:"121047287",c5:"",bt:"",st:"",at:"",rei:"0",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-20",a:"N2ALH_aelbadmoussi",dos:"121050398",c5:"",bt:"La cliente signal un retard de livraison",st:"Remboursement de la commande",at:"Puisque la cliente a refus√© de patienter, j'ai proc√©d√© √† son remboursement imm√©diat.",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"Ikram",d:"2026-02-20",a:"N2ALH_skarman",dos:"120283014",c5:"",bt:"Produit en panne: mises √† jour impossibles et absence de solution conforme du vendeur",st:"Remboursement",at:"La cliente a retourn√© le t√©l√©phone au vendeur, qui l'a r√©ceptionn√© le 31/01/2026.",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-20",a:"N2ALH_Selbaz",dos:"121009349",c5:"",bt:"Produit en panne",st:"",at:"",rei:"",bc:[],sc:[],ac:[],by:""},
  {r:"Chaimae",d:"2026-02-20",a:"N2ALH_camezian",dos:"121057966",c5:"",bt:"Remboursement non re√ßu",st:"RAS",at:"Le client confirme la rec√©ption de son RBT finallement",rei:"",bc:[],sc:[],ac:[],by:""}
];

// ‚îÄ‚îÄ CONFIG FIREBASE REST ‚îÄ‚îÄ
const FB_URL = "https://suivi-superviseurs-default-rtdb.firebaseio.com/suivi/data";

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser = '';
let tableData = [];
let cRI = -1, cF = '', cCh = [];
let syncInterval = null;
let lastSavedHash = '';

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
function login() {
  const n = document.getElementById('nameInput').value.trim();
  if (!n) { document.getElementById('loginError').style.display='block'; return; }
  currentUser = n.toUpperCase();
  document.getElementById('userDisplay').textContent = currentUser;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';
  initData();
}

// ‚îÄ‚îÄ INIT DATA ‚îÄ‚îÄ
async function initData() {
  setStatus('busy', 'Connexion...');
  try {
    const res = await fetch(FB_URL + '.json');
    const data = await res.json();
    if (data) {
      tableData = Array.isArray(data) ? data : Object.values(data);
    } else {
      tableData = JSON.parse(JSON.stringify(DEFAULT));
      await save();
    }
    lastSavedHash = JSON.stringify(tableData);
    renderTable();
    setStatus('on', 'En direct ‚ö°');
    startSync();
  } catch(e) {
    setStatus('off', 'Hors ligne');
    tableData = JSON.parse(JSON.stringify(DEFAULT));
    renderTable();
  }
}

// ‚îÄ‚îÄ SYNC toutes les 4 secondes ‚îÄ‚îÄ
function startSync() {
  syncInterval = setInterval(async () => {
    try {
      const res = await fetch(FB_URL + '.json');
      const data = await res.json();
      if (data) {
        const incoming = Array.isArray(data) ? data : Object.values(data);
        const incomingHash = JSON.stringify(incoming);
        if (incomingHash !== lastSavedHash) {
          tableData = incoming;
          lastSavedHash = incomingHash;
          renderTable();
          showToast('üîÑ Tableau mis √† jour');
        }
      }
      setStatus('on', 'En direct ‚ö°');
    } catch(e) {
      setStatus('off', 'Hors ligne');
    }
  }, 4000);
}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
async function save() {
  setStatus('busy', 'Sauvegarde...');
  try {
    const obj = {};
    tableData.forEach((row, i) => obj[i] = row);
    await fetch(FB_URL + '.json', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(obj)
    });
    lastSavedHash = JSON.stringify(tableData);
    setStatus('on', 'En direct ‚ö°');
  } catch(e) {
    setStatus('off', 'Erreur sync');
    showToast('‚ö†Ô∏è Erreur de synchronisation');
  }
}

function setStatus(state, label) {
  const dot = document.getElementById('syncDot');
  const lbl = document.getElementById('syncLabel');
  dot.className = 'dot' + (state === 'off' ? ' off' : state === 'busy' ? ' busy' : '');
  lbl.textContent = label;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderTable() {
  const tbody = document.getElementById('tableBody');
  // Save scroll position
  const wrapper = document.querySelector('.table-wrapper');
  const scrollTop = wrapper.scrollTop;

  tbody.innerHTML = '';
  tableData.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center;vertical-align:middle;">
        <button onclick="deleteRow(${i})" style="background:none;border:none;cursor:pointer;font-size:16px;color:#e53935;padding:2px 6px;border-radius:4px;transition:background 0.15s;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='none'" title="Supprimer la ligne">üóëÔ∏è</button>
      </td>
      <td class="tname" contenteditable="true" onblur="upd(${i},'r',this.innerText)">${esc(row.r)}</td>
      <td class="tdate" contenteditable="true" onblur="upd(${i},'d',this.innerText)">${esc(row.d)}</td>
      <td contenteditable="true" onblur="upd(${i},'a',this.innerText)">${esc(row.a)}</td>
      <td class="tn" contenteditable="true" onblur="upd(${i},'dos',this.innerText)">${esc(row.dos)}</td>
      <td class="tn" contenteditable="true" onblur="upd(${i},'rei',this.innerText)">${esc(row.rei)}</td>
      <td class="mcell" onclick="openModal(${i},'bc')">
        ${renderTags(row.bc,'b')}
        ${row.by ? `<div class="eby">‚úèÔ∏è ${esc(row.by)}</div>` : ''}
      </td>
      <td class="mcell" onclick="openModal(${i},'sc')">${renderTags(row.sc,'s')}</td>
      <td class="mcell" onclick="openModal(${i},'ac')">${renderTags(row.ac,'a')}</td>
    `;
    tbody.appendChild(tr);
  });

  wrapper.scrollTop = scrollTop;
}

function renderTags(arr, cls) {
  if (!arr || !arr.length) return '<span class="ehint">Cliquer pour choisir...</span>';
  return '<div class="tag-list">'+arr.map(v=>`<span class="tag ${cls}">${esc(v)}</span>`).join('')+'</div>';
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function upd(i, f, v) {
  tableData[i][f] = v.trim();
  tableData[i].by = currentUser;
  await save();
  showToast('‚úÖ Sauvegard√©');
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(ri, field) {
  cRI = ri; cF = field;
  const titles = { bc:'üîµ Blocage rencontr√©', sc:'üü¢ Solution propos√©e', ac:'üü£ Arguments' };
  const maps   = { bc:BLOCAGES, sc:SOLUTIONS, ac:ARGUMENTS };
  cCh = maps[field];
  const sel = tableData[ri][field] || [];

  document.getElementById('modalTitle').textContent = titles[field];
  document.getElementById('modalBody').innerHTML = cCh.map((c, i) => {
    const chk = sel.includes(c);
    return `<div class="ci ${chk?'ck':''}" id="ci_${i}">
      <input type="checkbox" id="chk_${i}" ${chk?'checked':''} onchange="sc2(${i})">
      <label for="chk_${i}">${esc(c)}</label>
    </div>`;
  }).join('');

  updCnt();
  document.getElementById('overlay').classList.add('open');
}

function sc2(i) {
  const chk = document.getElementById('chk_'+i);
  document.getElementById('ci_'+i).classList.toggle('ck', chk.checked);
  updCnt();
}
function updCnt() {
  document.getElementById('cnt').textContent =
    document.querySelectorAll('#modalBody input:checked').length;
}
async function saveModal() {
  const sel = [];
  cCh.forEach((c, i) => { if(document.getElementById('chk_'+i)?.checked) sel.push(c); });
  tableData[cRI][cF] = sel;
  tableData[cRI].by = currentUser;
  closeModal();
  renderTable();
  await save();
  showToast('‚úÖ Modifications partag√©es avec tous les superviseurs');
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); }

// ‚îÄ‚îÄ ADD ROW ‚îÄ‚îÄ
async function addRow() {
  tableData.push({
    r:currentUser, d:new Date().toISOString().slice(0,10),
    a:'', dos:'', c5:'', bt:'', st:'', at:'', rei:'',
    bc:[], sc:[], ac:[], by:currentUser
  });
  renderTable();
  await save();
  document.querySelector('.table-wrapper').scrollTop = 999999;
}

// ‚îÄ‚îÄ DELETE ROW ‚îÄ‚îÄ
async function deleteRow(i) {
  if (!confirm('Supprimer cette ligne ?')) return;
  tableData.splice(i, 1);
  renderTable();
  await save();
  showToast('üóëÔ∏è Ligne supprim√©e');
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportExcel() {
  const rows = [["Responsable","Date","Log Agent","Num Dossier","R√©it√©ration",
    "Blocage ‚Äî Choix","Solution ‚Äî Choix","Arguments ‚Äî Choix","Modifi√© par"]];
  tableData.forEach(r => rows.push([
    r.r,r.d,r.a,r.dos,r.rei,
    (r.bc||[]).join('\n'),(r.sc||[]).join('\n'),(r.ac||[]).join('\n'),r.by||''
  ]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:14},{wch:12},{wch:16},{wch:13},{wch:10},
    {wch:38},{wch:38},{wch:38},{wch:12}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Feuil1");
  XLSX.writeFile(wb, "suivi_superviseurs.xlsx");
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>
